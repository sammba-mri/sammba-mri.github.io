

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Template creation &mdash; Multimodal Imaging of Neurodegenerative Diseases and Therapies</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
  

  
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Multimodal Imaging of Neurodegenerative Diseases and Therapies" href="../index.html"/>
        <link rel="up" title="Gallery of Examples" href="index.html"/>
        <link rel="next" title="sammba-MRI API Reference" href="../reference.html"/>
        <link rel="prev" title="Confounds exploration" href="plot_confounds.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> sammba-MRI
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user_guide.html">User guide: table of contents</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Gallery of Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#dicom-to-nifti">DICOM to Nifti</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#template-creation">Template creation</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#registration-to-standard">Registration to standard</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#functional-connectivity">Functional connectivity</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="plot_confounds.html">Confounds exploration</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Template creation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#register-using-center-of-mass">Register using center of mass</a></li>
<li class="toctree-l4"><a class="reference internal" href="#shift-rotate">Shift rotate</a></li>
<li class="toctree-l4"><a class="reference internal" href="#affine-transform">Affine transform</a></li>
<li class="toctree-l4"><a class="reference internal" href="#non-linear-registration">Non-linear registration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#registr-to-template">Registr to template</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visualize-the-pipeline">Visualize the pipeline</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">sammba-MRI API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">sammba-MRI</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Gallery of Examples</a> &raquo;</li>
        
      <li>Template creation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="template-creation">
<span id="sphx-glr-auto-examples-plot-register-py"></span><h1>Template creation<a class="headerlink" href="#template-creation" title="Permalink to this headline">¶</a></h1>
<p>Here we show how to create a template from multiple anatomical scans.
Initially, registration is of extracted brains. Once these are reasonably
aligned, whole heads are registered, weighted by masks that, if parameters
are chosen well, include some scalp. The amount of scalp is hopefully enough
to help in differentiating the brain-scalp boundary without including so much
head tissue that it starts to contaminate the registration with the highly
variable head tissue.</p>
<p>Retrieve the data</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sammba</span> <span class="kn">import</span> <span class="n">data_fetchers</span>

<span class="n">retest</span> <span class="o">=</span> <span class="n">data_fetchers</span><span class="o">.</span><span class="n">fetch_zurich_test_retest</span><span class="p">(</span><span class="n">subjects</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
<p>and define the caching directory</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nipype.caching</span> <span class="kn">import</span> <span class="n">Memory</span>

<span class="n">cache_directory</span> <span class="o">=</span> <span class="s1">&#39;/tmp&#39;</span>
<span class="n">memory</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">(</span><span class="n">cache_directory</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="register-using-center-of-mass">
<h2>Register using center of mass<a class="headerlink" href="#register-using-center-of-mass" title="Permalink to this headline">¶</a></h2>
<p>An initial coarse registration is done using brain centre of mass (CoM).</p>
<p>First we loop through anatomical scans and correct intensities for bias.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">afni</span>

<span class="n">unifize</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">Unifize</span><span class="p">)</span>
<span class="n">unifized_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">anat_file</span> <span class="ow">in</span> <span class="n">retest</span><span class="o">.</span><span class="n">anat</span><span class="p">:</span>
    <span class="n">out_unifize</span> <span class="o">=</span> <span class="n">unifize</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">anat_file</span><span class="p">,</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
    <span class="n">unifized_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_unifize</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>
</pre></div>
</div>
<p>Second extract brains, aided by an approximate guessed brain volume,
and set the NIfTI image centre (as defined in the header) to the CoM
of the extracted brain.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">afni</span><span class="p">,</span> <span class="n">fsl</span>
<span class="kn">from</span> <span class="nn">sammba.interfaces</span> <span class="kn">import</span> <span class="n">RatsMM</span>

<span class="n">clip_level</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">ClipLevel</span><span class="p">)</span>
<span class="n">rats</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">RatsMM</span><span class="p">)</span>
<span class="n">apply_mask</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyMask</span><span class="p">)</span>
<span class="n">center_mass</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">CenterMass</span><span class="p">)</span>
<span class="n">brain_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">unifized_file</span> <span class="ow">in</span> <span class="n">unifized_files</span><span class="p">:</span>
    <span class="n">out_clip_level</span> <span class="o">=</span> <span class="n">clip_level</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">unifized_file</span><span class="p">)</span>
    <span class="n">out_rats</span> <span class="o">=</span> <span class="n">rats</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">unifized_file</span><span class="p">,</span>
                    <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;UnBm.nii.gz&#39;</span><span class="p">,</span>
                    <span class="n">volume_threshold</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
                    <span class="n">intensity_threshold</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">out_clip_level</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">clip_val</span><span class="p">))</span>
    <span class="n">out_apply_mask</span> <span class="o">=</span> <span class="n">apply_mask</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">unifized_file</span><span class="p">,</span>
                                <span class="n">mask_file</span><span class="o">=</span><span class="n">out_rats</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>
    <span class="n">out_center_mass</span> <span class="o">=</span> <span class="n">center_mass</span><span class="p">(</span>
        <span class="n">in_file</span><span class="o">=</span><span class="n">out_apply_mask</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
        <span class="n">cm_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_directory</span><span class="p">,</span> <span class="s1">&#39;cm.txt&#39;</span><span class="p">),</span>
        <span class="n">set_cm</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">brain_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_center_mass</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>
</pre></div>
</div>
<p>Same header change, for head files.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">refit</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">Refit</span><span class="p">)</span>
<span class="n">head_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">brain_file</span> <span class="ow">in</span> <span class="n">brain_files</span><span class="p">:</span>
    <span class="n">out_refit</span> <span class="o">=</span> <span class="n">refit</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">unifized_file</span><span class="p">,</span> <span class="n">duporigin_file</span><span class="o">=</span><span class="n">brain_file</span><span class="p">)</span>
    <span class="n">head_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_refit</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>
</pre></div>
</div>
<p>The brain files with new image center are concatenated to produce
a quality check video</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">tcat</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">TCat</span><span class="p">)</span>
<span class="n">out_tcat</span> <span class="o">=</span> <span class="n">tcat</span><span class="p">(</span><span class="n">in_files</span><span class="o">=</span><span class="n">brain_files</span><span class="p">,</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>and averaged</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">tstat</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">TStat</span><span class="p">)</span>
<span class="n">out_tstat</span> <span class="o">=</span> <span class="n">tstat</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">out_tcat</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>to create an empty template, with origin placed at CoM</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">undump</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">Undump</span><span class="p">)</span>
<span class="n">out_undump</span> <span class="o">=</span> <span class="n">undump</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">out_tstat</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
<span class="n">out_refit</span> <span class="o">=</span> <span class="n">refit</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">out_undump</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                  <span class="n">xorigin</span><span class="o">=</span><span class="s1">&#39;cen&#39;</span><span class="p">,</span> <span class="n">yorigin</span><span class="o">=</span><span class="s1">&#39;cen&#39;</span><span class="p">,</span> <span class="n">zorigin</span><span class="o">=</span><span class="s1">&#39;cen&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we shift heads and brains within the images to place the CoM at the
image center.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">resample</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">Resample</span><span class="p">)</span>
<span class="n">shifted_head_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">head_file</span> <span class="ow">in</span> <span class="n">head_files</span><span class="p">:</span>
    <span class="n">out_resample</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">head_file</span><span class="p">,</span>
                            <span class="n">master</span><span class="o">=</span><span class="n">out_refit</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                            <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
    <span class="n">shifted_head_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_resample</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>

<span class="n">shifted_brain_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">brain_file</span> <span class="ow">in</span> <span class="n">brain_files</span><span class="p">:</span>
    <span class="n">out_resample</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">brain_file</span><span class="p">,</span>
                            <span class="n">master</span><span class="o">=</span><span class="n">out_refit</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                            <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
    <span class="n">shifted_brain_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_resample</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>
</pre></div>
</div>
<p>Quality check videos and average brain</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">out_tcat</span> <span class="o">=</span> <span class="n">tcat</span><span class="p">(</span><span class="n">in_files</span><span class="o">=</span><span class="n">shifted_brain_files</span><span class="p">,</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
<span class="n">out_tstat_shifted_brain</span> <span class="o">=</span> <span class="n">tstat</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">out_tcat</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                                <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>At this point, we achieved a translation-only registration of the raw
anatomical images to each other’s brain’s (as defined by the brain extractor)
CoMs.</p>
</div>
<div class="section" id="shift-rotate">
<h2>Shift rotate<a class="headerlink" href="#shift-rotate" title="Permalink to this headline">¶</a></h2>
<p>Now we move to rigid-body registration of CoM brains, and application of this
registration to CoM heads. This registration requires a target template.
Here we use mean of all bias-corrected, brain-extracted, mass-centered
images. Other possibilities include an externally-sourced image or, more
biased, a nicely-aligned individual.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">allineate</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">Allineate</span><span class="p">)</span>
<span class="n">shift_rotated_brain_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">rigid_transform_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">shifted_brain_file</span> <span class="ow">in</span> <span class="n">shifted_brain_files</span><span class="p">:</span>
    <span class="n">out_allineate</span> <span class="o">=</span> <span class="n">allineate</span><span class="p">(</span>
        <span class="n">in_file</span><span class="o">=</span><span class="n">shifted_brain_file</span><span class="p">,</span>
        <span class="n">reference</span><span class="o">=</span><span class="n">out_tstat_shifted_brain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
        <span class="n">out_matrix</span><span class="o">=</span><span class="s1">&#39;UnBmBeCCAl3.aff12.1D&#39;</span><span class="p">,</span>
        <span class="n">convergence</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
        <span class="n">two_blur</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">warp_type</span><span class="o">=</span><span class="s1">&#39;shift_rotate&#39;</span><span class="p">,</span>
        <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;UnBmBeCCAl3.nii.gz&#39;</span><span class="p">)</span>
    <span class="n">rigid_transform_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_allineate</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_matrix</span><span class="p">)</span>
    <span class="n">shift_rotated_brain_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_allineate</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>
</pre></div>
</div>
<p>Application to the whole head image. can also be used for a good
demonstration of linear vs. non-linear registration quality</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">shift_rotated_head_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">shifted_head_file</span><span class="p">,</span> <span class="n">rigid_transform_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shifted_head_files</span><span class="p">,</span>
                                                   <span class="n">rigid_transform_files</span><span class="p">):</span>
    <span class="n">out_allineate</span> <span class="o">=</span> <span class="n">allineate</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">shifted_head_file</span><span class="p">,</span>
                              <span class="n">master</span><span class="o">=</span><span class="n">out_tstat_shifted_brain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                              <span class="n">in_matrix</span><span class="o">=</span><span class="n">rigid_transform_file</span><span class="p">,</span>
                              <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;UnBmBeCCAa3.nii.gz&#39;</span><span class="p">)</span>
    <span class="n">shift_rotated_head_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_allineate</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that this rigid body registration may need to be run more than once.
Now we produce an average of rigid body registered heads</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">out_tcat</span> <span class="o">=</span> <span class="n">tcat</span><span class="p">(</span><span class="n">in_files</span><span class="o">=</span><span class="n">shift_rotated_head_files</span><span class="p">,</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
<span class="n">out_tstat_shr</span> <span class="o">=</span> <span class="n">tstat</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">out_tcat</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>and a count mask, useful for looking at brain extraction efficiency
and differences in brain size.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">mask_tool</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">MaskTool</span><span class="p">)</span>
<span class="n">out_mask_tool</span> <span class="o">=</span> <span class="n">mask_tool</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">out_tcat</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                          <span class="n">count</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                          <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="affine-transform">
<h2>Affine transform<a class="headerlink" href="#affine-transform" title="Permalink to this headline">¶</a></h2>
<p>We begin by achieving an affine registration on aligned heads.
A weighting mask is used to …</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">affine_transform_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">catmatvec</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">CatMatvec</span><span class="p">)</span>
<span class="k">for</span> <span class="n">shift_rotated_head_file</span><span class="p">,</span> <span class="n">rigid_transform_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">shift_rotated_head_files</span><span class="p">,</span> <span class="n">rigid_transform_files</span><span class="p">):</span>
    <span class="n">out_allineate</span> <span class="o">=</span> <span class="n">allineate</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">shift_rotated_head_file</span><span class="p">,</span>
                              <span class="n">reference</span><span class="o">=</span><span class="n">out_tstat_shr</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                              <span class="n">out_matrix</span><span class="o">=</span><span class="s1">&#39;UnBmBeAl4.aff12.1D&#39;</span><span class="p">,</span>
                              <span class="n">convergence</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                              <span class="n">two_blur</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">one_pass</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                              <span class="n">weight</span><span class="o">=</span><span class="n">out_mask_tool</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                              <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;UnBmBeAl4.nii.gz&#39;</span><span class="p">)</span>
    <span class="n">catmatvec_out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">rigid_transform_file</span><span class="p">),</span>
                                      <span class="s1">&#39;UnBmBeCCAl3UnCCAl4.aff12.1D&#39;</span><span class="p">)</span>
    <span class="n">out_catmatvec</span> <span class="o">=</span> <span class="n">catmatvec</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="p">[(</span><span class="n">rigid_transform_file</span><span class="p">,</span> <span class="s1">&#39;ONELINE&#39;</span><span class="p">),</span>
                                       <span class="p">(</span><span class="n">out_allineate</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_matrix</span><span class="p">,</span>
                                        <span class="s1">&#39;ONELINE&#39;</span><span class="p">)],</span>
                              <span class="n">out_file</span><span class="o">=</span><span class="n">catmatvec_out_file</span><span class="p">)</span>
    <span class="n">affine_transform_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">catmatvec_out_file</span><span class="p">)</span>
</pre></div>
</div>
<p>Typically, convergence should be set to 0.005 but we increase it for speed
reason.</p>
<p>Each resulting registration matrix is concatenated to the corresponding
rigid bory registration matrix then directly applied to the CoM brain
and head, reducing reslice errors in the final result.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">allineated_brain_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">shifted_brain_file</span><span class="p">,</span> <span class="n">affine_transform_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="n">shifted_brain_files</span><span class="p">,</span> <span class="n">affine_transform_files</span><span class="p">):</span>
    <span class="n">out_allineate</span> <span class="o">=</span> <span class="n">allineate</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">shifted_brain_file</span><span class="p">,</span>
                              <span class="n">master</span><span class="o">=</span><span class="n">out_tstat_shr</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                              <span class="n">in_matrix</span><span class="o">=</span><span class="n">affine_transform_file</span><span class="p">,</span>
                              <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;UnBmBeCCAa4.nii.gz&#39;</span><span class="p">)</span>
    <span class="n">allineated_brain_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_allineate</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>
</pre></div>
</div>
<p>The application to the whole head image can also be used for a good
demonstration of linear vs. non-linear registration quality.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">allineated_head_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">shifted_head_file</span><span class="p">,</span> <span class="n">affine_transform_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shifted_brain_files</span><span class="p">,</span>
                                                    <span class="n">affine_transform_files</span><span class="p">):</span>
    <span class="n">out_allineate</span> <span class="o">=</span> <span class="n">allineate</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">shifted_head_file</span><span class="p">,</span>
                              <span class="n">master</span><span class="o">=</span><span class="n">out_tstat_shr</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                              <span class="n">in_matrix</span><span class="o">=</span><span class="n">affine_transform_file</span><span class="p">,</span>
                              <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;UnCCAa.nii.gz&#39;</span><span class="p">)</span>
    <span class="n">allineated_head_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_allineate</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>
</pre></div>
</div>
<p>Quality check videos and template</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">out_tcat_head</span> <span class="o">=</span> <span class="n">tcat</span><span class="p">(</span><span class="n">in_files</span><span class="o">=</span><span class="n">allineated_head_files</span><span class="p">,</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
<span class="n">out_tstat_allineated_head</span> <span class="o">=</span> <span class="n">tstat</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">out_tcat_head</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                                  <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="non-linear-registration">
<h2>Non-linear registration<a class="headerlink" href="#non-linear-registration" title="Permalink to this headline">¶</a></h2>
<p>A weight mask that extends beyond the brain, incorporating some
surrounding tissue, is needed to help better define the brain head boundary.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">out_mask_tool</span> <span class="o">=</span> <span class="n">mask_tool</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">out_tcat</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                          <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
<span class="n">out_mask_tool</span> <span class="o">=</span> <span class="n">mask_tool</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">out_tcat</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="n">union</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                          <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
<span class="n">out_mask_tool</span> <span class="o">=</span> <span class="n">mask_tool</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">out_mask_tool</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                          <span class="n">dilate_inputs</span><span class="o">=</span><span class="s1">&#39;4&#39;</span><span class="p">,</span>
                          <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The input source images are initially transformed prior to registration,
to ensure that they are already quite well-aligned to the template.
To save time, we only achieve one refinement level per step</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nipype.utils.filemanip</span> <span class="kn">import</span> <span class="n">fname_presuffix</span>

<span class="n">qwarp</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">Qwarp</span><span class="p">)</span>
<span class="n">warped_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">warp_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">affine_transform_file</span><span class="p">,</span> <span class="n">shifted_head_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">affine_transform_files</span><span class="p">,</span>
                                                    <span class="n">shifted_head_files</span><span class="p">):</span>
    <span class="n">out_qwarp</span> <span class="o">=</span> <span class="n">qwarp</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">shifted_head_file</span><span class="p">,</span>
                      <span class="n">base_file</span><span class="o">=</span><span class="n">out_tstat_allineated_head</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                      <span class="n">nmi</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">noneg</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">iwarp</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">weight</span><span class="o">=</span><span class="n">out_mask_tool</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                      <span class="n">iniwarp</span><span class="o">=</span><span class="p">[</span><span class="n">affine_transform_file</span><span class="p">],</span>
                      <span class="n">inilev</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">maxlev</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">out_file</span><span class="o">=</span><span class="n">fname_presuffix</span><span class="p">(</span><span class="n">shifted_head_file</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;w1&#39;</span><span class="p">))</span>
    <span class="n">warp_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_qwarp</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">source_warp</span><span class="p">)</span>
    <span class="n">warped_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_qwarp</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">warped_source</span><span class="p">)</span>

<span class="n">out_tcat</span> <span class="o">=</span> <span class="n">tcat</span><span class="p">(</span><span class="n">in_files</span><span class="o">=</span><span class="n">warped_files</span><span class="p">,</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
<span class="n">out_tstat_warp_head</span> <span class="o">=</span> <span class="n">tstat</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">out_tcat</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                            <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-default"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">ext</span>
<span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">ext</span>
<span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">ext</span>
<span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">ext</span>
</pre></div>
</div>
<p>Then iterative registration from a given level to another is achieved.
Note that any level below a patch size of 25 will not be done (see 3dQwarp
help for further detail).
The input transform is the former warp and needs to be concatenated to IDENT
initially; I forget why, I think it is to avoid some weird bug.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">nwarp_cat</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">NwarpCat</span><span class="p">)</span>
<span class="n">warped_files2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">warp_files2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">warp_file</span><span class="p">,</span> <span class="n">shifted_head_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">warp_files</span><span class="p">,</span> <span class="n">shifted_head_files</span><span class="p">):</span>
    <span class="n">out_nwarp_cat</span> <span class="o">=</span> <span class="n">nwarp_cat</span><span class="p">(</span>
        <span class="n">in_files</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;IDENT&#39;</span><span class="p">,</span> <span class="n">out_tstat_warp_head</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">),</span>
                  <span class="n">warp_file</span><span class="p">],</span> <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;iniwarp.nii.gz&#39;</span><span class="p">)</span>
    <span class="n">out_qwarp</span> <span class="o">=</span> <span class="n">qwarp</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">shifted_head_file</span><span class="p">,</span>
                      <span class="n">base_file</span><span class="o">=</span><span class="n">out_tstat_warp_head</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                      <span class="n">nmi</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">noneg</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">iwarp</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">weight</span><span class="o">=</span><span class="n">out_mask_tool</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                      <span class="n">iniwarp</span><span class="o">=</span><span class="p">[</span><span class="n">out_nwarp_cat</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">],</span>
                      <span class="n">inilev</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                      <span class="n">maxlev</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                      <span class="n">out_file</span><span class="o">=</span><span class="n">fname_presuffix</span><span class="p">(</span><span class="n">shifted_head_file</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;w2&#39;</span><span class="p">))</span>
    <span class="n">warp_files2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_qwarp</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">source_warp</span><span class="p">)</span>
    <span class="n">warped_files2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_qwarp</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">warped_source</span><span class="p">)</span>

<span class="n">out_tcat</span> <span class="o">=</span> <span class="n">tcat</span><span class="p">(</span><span class="n">in_files</span><span class="o">=</span><span class="n">warped_files2</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;w2_videohead.nii.gz&#39;</span><span class="p">)</span>
<span class="n">out_tstat_warp_head2</span> <span class="o">=</span> <span class="n">tstat</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">out_tcat</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                             <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;w2_meanhead.nii.gz&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-default"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">ext</span>
<span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">ext</span>
<span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">ext</span>
<span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">ext</span>
</pre></div>
</div>
<p>Using previous files and concatenated transforms can be exploited to avoid
building up reslice errors.
Warp with mini-patch
In this particular case, minpatch=75 corresponds to a level of 4</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">warped_files3</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">warp_files3</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">warp_file</span><span class="p">,</span> <span class="n">shifted_head_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">warp_files2</span><span class="p">,</span> <span class="n">shifted_head_files</span><span class="p">):</span>
    <span class="n">out_qwarp</span> <span class="o">=</span> <span class="n">qwarp</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">shifted_head_file</span><span class="p">,</span>
                      <span class="n">base_file</span><span class="o">=</span><span class="n">out_tstat_warp_head2</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                      <span class="n">nmi</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">noneg</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">iwarp</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">weight</span><span class="o">=</span><span class="n">out_mask_tool</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                      <span class="n">iniwarp</span><span class="o">=</span><span class="p">[</span><span class="n">warp_file</span><span class="p">],</span>
                      <span class="n">inilev</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                      <span class="n">minpatch</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span>
                      <span class="n">out_file</span><span class="o">=</span><span class="n">fname_presuffix</span><span class="p">(</span><span class="n">shifted_head_file</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;w3&#39;</span><span class="p">))</span>
    <span class="n">warped_files3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_qwarp</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">warped_source</span><span class="p">)</span>
    <span class="n">warp_files3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_qwarp</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">source_warp</span><span class="p">)</span>

<span class="n">out_tcat</span> <span class="o">=</span> <span class="n">tcat</span><span class="p">(</span><span class="n">in_files</span><span class="o">=</span><span class="n">warped_files3</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;w3_videohead.nii.gz&#39;</span><span class="p">)</span>
<span class="n">out_tstat_warp_head3</span> <span class="o">=</span> <span class="n">tstat</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">out_tcat</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                             <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;w3_meanhead.nii.gz&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-default"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">ext</span>
<span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">ext</span>
<span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">ext</span>
<span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">ext</span>
</pre></div>
</div>
<p>We can repeat this very last warp while using the last average until we are
satisfied with the template quality</p>
</div>
<div class="section" id="registr-to-template">
<h2>Registr to template<a class="headerlink" href="#registr-to-template" title="Permalink to this headline">¶</a></h2>
<p>Apply non-linear registration results to uncorrected images</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">warp_apply</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">NwarpApply</span><span class="p">)</span>
<span class="k">for</span> <span class="n">head_file</span><span class="p">,</span> <span class="n">warp_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">head_files</span><span class="p">,</span> <span class="n">warp_files3</span><span class="p">):</span>
    <span class="n">out_warp_apply</span> <span class="o">=</span> <span class="n">warp_apply</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">head_file</span><span class="p">,</span>
                                <span class="n">warp</span><span class="o">=</span><span class="n">warp_file</span><span class="p">,</span>
                                <span class="n">master</span><span class="o">=</span><span class="n">out_tstat_warp_head3</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
                                <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;Na.nii.gz&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Visualize one individual anat on top of template</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span>

<span class="n">display</span> <span class="o">=</span> <a href="http://nilearn.github.io/modules/generated/nilearn.plotting.plot_anat.html#nilearn.plotting.plot_anat" class="sphx-glr-code-links" tooltip="Link to documentation for nilearn.plotting.plot_anat"><span class="n">plotting</span><span class="o">.</span><span class="n">plot_anat</span></a><span class="p">(</span><span class="n">out_warp_apply</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mf">1.7</span><span class="p">)</span>
<span class="n">display</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">out_tstat_warp_head3</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>

<a href="http://nilearn.github.io/modules/generated/nilearn.plotting.show.html#nilearn.plotting.show" class="sphx-glr-code-links" tooltip="Link to documentation for nilearn.plotting.show"><span class="n">plotting</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_register_001.png" class="align-center" src="../_images/sphx_glr_plot_register_001.png" />
</div>
<div class="section" id="visualize-the-pipeline">
<h2>Visualize the pipeline<a class="headerlink" href="#visualize-the-pipeline" title="Permalink to this headline">¶</a></h2>
<p>If you want to go further, you can visualize the whole pipeline or a part of
it as a graph. For instance, we can draw the center of mass registration
steps.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nipype.pipeline.engine</span> <span class="kn">as</span> <span class="nn">pe</span>

<span class="n">workflow</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;CoM_registration&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Specify the pipeline steps</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">unifize_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Unifize</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bias_correct&#39;</span><span class="p">)</span>
<span class="n">clip_level_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">ClipLevel</span><span class="p">(),</span>
                          <span class="n">name</span><span class="o">=</span><span class="s1">&#39;compute_mask_threshold&#39;</span><span class="p">)</span>
<span class="n">rats_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">RatsMM</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;compute_brain_mask&#39;</span><span class="p">)</span>
<span class="n">apply_mask_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyMask</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;apply_brain_mask&#39;</span><span class="p">)</span>
<span class="n">center_mass_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">CenterMass</span><span class="p">(),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;compute_and_set_cm_in_header&#39;</span><span class="p">)</span>
<span class="n">refit_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">Refit</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;set_cm_in_header&#39;</span><span class="p">)</span>
<span class="n">tcat_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">TCat</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;concatenate_across_individuals&#39;</span><span class="p">)</span>
<span class="n">tstat_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">TStat</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;compute_average&#39;</span><span class="p">)</span>
<span class="n">undump_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">Undump</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;create_empty_template&#39;</span><span class="p">)</span>
<span class="n">refit_node2</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">Refit</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;set_cm_in_header2&#39;</span><span class="p">)</span>
<span class="n">resample_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">Resample</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;resample&#39;</span><span class="p">)</span>

<span class="n">workflow</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">([</span><span class="n">unifize_node</span><span class="p">,</span> <span class="n">clip_level_node</span><span class="p">,</span> <span class="n">rats_node</span><span class="p">,</span> <span class="n">apply_mask_node</span><span class="p">,</span>
                    <span class="n">center_mass_node</span><span class="p">,</span> <span class="n">refit_node</span><span class="p">,</span> <span class="n">tcat_node</span><span class="p">,</span> <span class="n">tstat_node</span><span class="p">,</span>
                    <span class="n">undump_node</span><span class="p">,</span> <span class="n">refit_node2</span><span class="p">,</span> <span class="n">resample_node</span><span class="p">])</span>
</pre></div>
</div>
<p>Specify connections</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nipype.pipeline.engine</span> <span class="kn">as</span> <span class="nn">pe</span>

<span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">unifize_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">clip_level_node</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">clip_level_node</span><span class="p">,</span> <span class="s1">&#39;clip_val&#39;</span><span class="p">,</span> <span class="n">rats_node</span><span class="p">,</span> <span class="s1">&#39;intensity_threshold&#39;</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">unifize_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">rats_node</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">rats_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">apply_mask_node</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">apply_mask_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">center_mass_node</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">unifize_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">refit_node</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">center_mass_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">refit_node</span><span class="p">,</span> <span class="s1">&#39;duporigin_file&#39;</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">center_mass_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">tcat_node</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">tcat_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">tstat_node</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">tstat_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">undump_node</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">undump_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">refit_node2</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">refit_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">resample_node</span><span class="p">,</span> <span class="s1">&#39;master&#39;</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">refit_node2</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">resample_node</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Generate the graph</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">write_graph</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Total running time of the script:</strong> ( 109 minutes  53.621 seconds)</p>
<div class="sphx-glr-footer docutils container">
<div class="sphx-glr-download docutils container">
<a class="reference download internal" href="../_downloads/plot_register.py" download=""><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_register.py</span></code></a></div>
<div class="sphx-glr-download docutils container">
<a class="reference download internal" href="../_downloads/plot_register.ipynb" download=""><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_register.ipynb</span></code></a></div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="http://sphinx-gallery.readthedocs.io">Generated by Sphinx-Gallery</a></p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../reference.html" class="btn btn-neutral float-right" title="sammba-MRI API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="plot_confounds.html" class="btn btn-neutral" title="Confounds exploration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, The sammba-MRI developers.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/copybutton.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>